<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AjeCoins Admin</title>
  <script type="module">
    // ðŸ”¹ Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, writeBatch } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ðŸ”¹ Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCsz2EP8IsTlG02uU2_GRfyQeeajMDuJjI",
      authDomain: "ajecoins-73829.firebaseapp.com",
      projectId: "ajecoins-73829",
      storageBucket: "ajecoins-73829.appspot.com",
      messagingSenderId: "247461322350",
      appId: "1:247461322350:web:802185ad39249ca650507f"
    };

    // ðŸ”¹ Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ðŸ”¹ Detectar separador CSV/TSV
    function detectSeparator(text) {
      const firstLine = text.split("\n")[0];
      if (firstLine.includes("\t")) return "\t";
      if (firstLine.includes(";")) return ";";
      return ",";
    }

    // ðŸ”¹ Cargar archivo CSV/TSV
    async function handleFileUpload(e, tipo) {
      const file = e.target.files[0];
      if (!file) return;
      const loader = document.getElementById("loading");
      loader.style.display = "block";

      try {
        const text = await file.text();
        const separator = detectSeparator(text);
        const lines = text.split("\n").map(l => l.trim()).filter(l => l);
        if (lines.length < 2) throw new Error("Archivo vacÃ­o o sin datos");

        const batch = writeBatch(db);

        if (tipo === "usuarios") {
          const data = lines.slice(1).map(line => {
            const values = line.split(separator).map(v => v.trim());
            return {
              fecha: values[0] || "",
              cedula: values[1] || "",
              nombre: values[2] || "",
              cedis: values[3] || "",
              coins_ganados: parseInt(values[4]) || 0
            };
          }).filter(u => u.cedula);

          data.forEach(u => {
            const docRef = doc(db, "usuarios", u.cedula);
            batch.set(docRef, u);
          });
          await batch.commit();
          alert("âœ… Usuarios cargados correctamente");
          loadUsuarios();

        } else if (tipo === "productos") {
          const data = lines.slice(1).map((line, index) => {
            const values = line.split(separator).map(v => v.trim());
            return {
              id: `prod_${index+1}`,
              nombre: values[0] || "",
              coins: parseInt(values[1]) || 0
            };
          }).filter(p => p.nombre);

          data.forEach(p => {
            const docRef = doc(db, "productos", p.id);
            batch.set(docRef, p);
          });
          await batch.commit();
          alert("âœ… Productos cargados correctamente");
          loadProductos();
        }

      } catch (err) {
        console.error(err);
        alert("âŒ Error al procesar el archivo. Verifica el formato CSV/TSV");
      }

      loader.style.display = "none";
      e.target.value = "";
    }

    // ðŸ”¹ Cargar usuarios de Firestore
    async function loadUsuarios() {
      const table = document.getElementById("usuarios-body");
      table.innerHTML = "";
      try {
        const snapshot = await getDocs(collection(db, "usuarios"));
        snapshot.forEach(doc => {
          const u = doc.data();
          const row = `<tr>
            <td>${u.fecha}</td>
            <td>${u.cedula}</td>
            <td>${u.nombre}</td>
            <td>${u.cedis}</td>
            <td>${u.coins_ganados}</td>
          </tr>`;
          table.innerHTML += row;
        });
      } catch (err) {
        console.error(err);
        alert("Error cargando usuarios desde Firebase");
      }
    }

    // ðŸ”¹ Cargar productos de Firestore
    async function loadProductos() {
      const table = document.getElementById("productos-body");
      table.innerHTML = "";
      try {
        const snapshot = await getDocs(collection(db, "productos"));
        snapshot.forEach(doc => {
          const p = doc.data();
          const row = `<tr>
            <td>${p.nombre}</td>
            <td>${p.coins}</td>
          </tr>`;
          table.innerHTML += row;
        });
      } catch (err) {
        console.error(err);
        alert("Error cargando productos desde Firebase");
      }
    }

    window.handleFileUpload = handleFileUpload;
    window.loadUsuarios = loadUsuarios;
    window.loadProductos = loadProductos;
  </script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f8fafc; }
    table { width: 100%; border-collapse: collapse; margin-bottom:20px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#d1fae5; color:#065f46; }
    tr:hover { background:#f0fdf4; }
    #loading { display:none; color:#065f46; font-weight:bold; }
    input[type=file] { display:none; }
    label { cursor:pointer; background:#d1fae5; padding:6px 12px; border-radius:6px; display:inline-block; margin-bottom:10px; }
  </style>
</head>
<body>
  <h1>AjeCoins Admin</h1>
  <p id="loading">Cargando...</p>

  <h2>Usuarios</h2>
  <label>Cargar Usuarios CSV/TSV
    <input type="file" onchange="handleFileUpload(event,'usuarios')">
  </label>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>CÃ©dula</th>
        <th>Nombre</th>
        <th>CEDIS</th>
        <th>Coins</th>
      </tr>
    </thead>
    <tbody id="usuarios-body"></tbody>
  </table>

  <h2>Productos</h2>
  <label>Cargar Productos CSV/TSV
    <input type="file" onchange="handleFileUpload(event,'productos')">
  </label>
  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Coins</th>
      </tr>
    </thead>
    <tbody id="productos-body"></tbody>
  </table>

  <button onclick="loadUsuarios(); loadProductos();">Actualizar Datos</button>
</body>
</html>
