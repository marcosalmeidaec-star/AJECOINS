<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>AJE Coins - Usuario</title>
<link rel="stylesheet" href="styles.css">
<style>
    #productosContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        padding: 15px 0;
    }

    .producto-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
        padding: 10px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: transform 0.2s;
    }

    .producto-card:hover { transform: translateY(-3px); }
    .producto-img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 10px; }
    .producto-nombre { font-size: 14px; margin: 5px 0; }
    .producto-coins { font-size: 12px; color: #555; margin-bottom: 10px; }
    .btn-agregar { background-color: #00a651; border: none; border-radius: 8px; padding: 5px 10px; cursor: pointer; font-weight: bold; transition: background 0.2s; color: #fff; }
    .btn-agregar:hover { background-color: #008f44; }
    #carrito { margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; background: #fafafa; }
    #btnSolicitar { margin-top: 10px; background-color: #00a651; color: #fff; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    #btnSolicitar:hover { background-color: #008f44; }
    #tablaHistorial { width: 100%; border-collapse: collapse; margin-top: 10px; font-family: Arial, sans-serif; }
    #tablaHistorial thead { background-color: #f5f5f5; }
    #tablaHistorial th, #tablaHistorial td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd; }
    #tablaHistorial tbody tr:hover { background-color: #f9f9f9; }
    #tablaHistorial th { font-weight: 600; font-size: 14px; color: #333; }
    #tablaHistorial td { font-size: 13px; color: #555; }
    #alertaCoins { background: #ff4d4d; color: #fff; padding: 8px 12px; border-radius: 8px; margin-top: 10px; display: none; text-align: center; font-weight: bold; }
    .cantidad-btn { background: #00a651; color: #fff; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; margin: 0 3px; }
    .cantidad-btn:hover { background: #008f44; }
</style>
</head>
<body>

<div class="container">
    <h1>Consulta tus AJE Coins</h1>

    <input type="text" id="cedulaInput" placeholder="Ingresa tu cédula">
    <button id="buscarBtn">Buscar</button>

    <p id="mensaje"></p>
    <div id="alertaCoins"></div>

    <div id="infoUsuario" style="display:none;">
        <h3>Datos del usuario</h3>
        <p><strong>Nombre:</strong> <span id="nombre"></span></p>
        <p><strong>CEDIS:</strong> <span id="cedis"></span></p>
        <p><strong>Coins actuales:</strong> <span id="coinsActuales"></span></p>

        <h3>Historial</h3>
        <table id="tablaHistorial">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Coins ganados</th>
                    <th>Producto</th>
                    <th>Coins canjeados</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Productos disponibles</h3>
        <div id="productosContainer"></div>

        <div id="carrito">
            <h4>Carrito</h4>
            <ul id="listaCarrito"></ul>
            <button id="btnSolicitar">Solicitar productos</button>
        </div>
    </div>

    <br>
    <a href="index.html">⬅ Volver al inicio</a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCsz2EP8IsTlG02uU2_GRfyQeeajMDuJjI",
    authDomain: "ajecoins-73829.firebaseapp.com",
    projectId: "ajecoins-73829",
    storageBucket: "ajecoins-73829.firebasestorage.app",
    messagingSenderId: "247461322350",
    appId: "1:247461322350:web:802185ad39249ca650507f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const cedulaInput = document.getElementById("cedulaInput");
const buscarBtn = document.getElementById("buscarBtn");
const mensaje = document.getElementById("mensaje");
const alertaCoins = document.getElementById("alertaCoins");

const infoUsuario = document.getElementById("infoUsuario");
const nombreSpan = document.getElementById("nombre");
const cedisSpan = document.getElementById("cedis");
const coinsActualesSpan = document.getElementById("coinsActuales");
const tablaHistorialBody = document.querySelector("#tablaHistorial tbody");

const productosContainer = document.getElementById("productosContainer");
const listaCarrito = document.getElementById("listaCarrito");
const btnSolicitar = document.getElementById("btnSolicitar");

let carrito = [];
let coinsUsuario = 0;

// Actualizar carrito y saldo visual
function actualizarCarrito() {
    listaCarrito.innerHTML = "";
    let totalCarrito = 0;

    carrito.forEach((item, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
            ${item.nombre} - ${item.coins * item.cantidad} coins
            <button class="cantidad-btn" data-index="${index}" data-action="menos">-</button>
            <span>${item.cantidad}</span>
            <button class="cantidad-btn" data-index="${index}" data-action="mas">+</button>
        `;
        listaCarrito.appendChild(li);
        totalCarrito += item.coins * item.cantidad;
    });

    coinsActualesSpan.innerText = coinsUsuario - totalCarrito;

    // Botones [+] y [-]
    listaCarrito.querySelectorAll(".cantidad-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const idx = Number(btn.dataset.index);
            const accion = btn.dataset.action;
            if (accion === "mas") {
                const totalCarritoActual = carrito.reduce((sum, p) => sum + p.coins * p.cantidad, 0);
                if (totalCarritoActual + carrito[idx].coins > coinsUsuario) {
                    alertaCoins.innerText = "❌ Usuario excedió el monto de coins actuales";
                    alertaCoins.style.display = "block";
                    return;
                }
                alertaCoins.style.display = "none";
                carrito[idx].cantidad += 1;
            } else if (accion === "menos") {
                carrito[idx].cantidad -= 1;
                if (carrito[idx].cantidad <= 0) {
                    carrito.splice(idx, 1);
                }
            }
            actualizarCarrito();
        });
    });
}

// Mostrar usuario y productos
async function mostrarUsuario(cedula) {
    tablaHistorialBody.innerHTML = "";
    productosContainer.innerHTML = "";
    listaCarrito.innerHTML = "";
    carrito = [];
    alertaCoins.style.display = "none";
    mensaje.innerText = "⏳ Cargando usuario...";
    infoUsuario.style.display = "none";

    try {
        const userRef = doc(db, "usuarios", cedula);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
            mensaje.innerText = "❌ Usuario no encontrado.";
            return;
        }

        const userData = userSnap.data();
        nombreSpan.innerText = userData.nombre || "Sin nombre";
        cedisSpan.innerText = userData.cedis || "Sin CEDIS";

        coinsUsuario = userData.coins_actuales || 0;
        coinsActualesSpan.innerText = coinsUsuario;

        const movimientosSnap = await getDocs(collection(db, "usuarios", cedula, "movimientos"));
        movimientosSnap.forEach(mov => {
            const data = mov.data();
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${data.fecha || "-"}</td>
                <td>${data.coins_ganados || 0}</td>
                <td>${data.producto || "-"}</td>
                <td>${data.coins_canjeados || 0}</td>
                <td>${data.coins_actuales || 0}</td>
            `;
            tablaHistorialBody.appendChild(tr);
        });

        infoUsuario.style.display = "block";
        mensaje.innerText = "";

        // Productos
        const productosSnap = await getDocs(collection(db, "productos"));
        productosSnap.forEach(docSnap => {
            const producto = docSnap.data();
            const card = document.createElement("div");
            card.classList.add("producto-card");
            card.innerHTML = `
                <img src="${producto.imagen || 'assets/productos/default.png'}" alt="${producto.nombre || 'Producto'}" class="producto-img" />
                <h3 class="producto-nombre">${producto.nombre || 'Producto'}</h3>
                <p class="producto-coins">${producto.coins || 0} coins</p>
                <button class="btn-agregar" data-nombre="${producto.nombre}" data-coins="${producto.coins}">
                    + Agregar
                </button>
            `;
            productosContainer.appendChild(card);
        });

        // Agregar productos al carrito
        productosContainer.querySelectorAll(".btn-agregar").forEach(btn => {
            btn.addEventListener("click", () => {
                const nombre = btn.dataset.nombre;
                const coins = Number(btn.dataset.coins) || 0;
                const totalCarrito = carrito.reduce((sum, item) => sum + item.coins * item.cantidad, 0);

                if (coins + totalCarrito > coinsUsuario) {
                    alertaCoins.innerText = "❌ Usuario excedió el monto de coins actuales";
                    alertaCoins.style.display = "block";
                    return;
                }

                alertaCoins.style.display = "none";

                const existente = carrito.find(item => item.nombre === nombre);
                if (existente) {
                    existente.cantidad += 1;
                } else {
                    carrito.push({ nombre, coins, cantidad: 1 });
                }

                actualizarCarrito();
            });
        });

    } catch (err) {
        console.error(err);
        mensaje.innerText = "❌ Error al cargar usuario.";
    }
}

// Solicitar productos
btnSolicitar.addEventListener("click", async () => {
    if (carrito.length === 0) {
        alertaCoins.innerText = "❌ No hay productos en el carrito";
        alertaCoins.style.display = "block";
        return;
    }

    const fecha = new Date().toLocaleDateString("es-ES");
    const cedula = cedulaInput.value.trim();
    const totalCarrito = carrito.reduce((sum, p) => sum + p.coins * p.cantidad, 0);

    try {
        for (const item of carrito) {
            const movimientoRef = doc(collection(db, "usuarios", cedula, "movimientos"));
            const dataMovimiento = {
                fecha,
                producto: item.nombre,
                coins_canjeados: item.coins * item.cantidad,
                coins_ganados: 0,
                coins_actuales: coinsUsuario - totalCarrito
            };
            await setDoc(movimientoRef, dataMovimiento);

            // Agregar fila directamente a la tabla sin recargar
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${fecha}</td>
                <td>0</td>
                <td>${item.nombre}</td>
                <td>${item.coins * item.cantidad}</td>
                <td>${coinsUsuario - totalCarrito}</td>
            `;
            tablaHistorialBody.appendChild(tr);
        }

        // Actualizar coins del usuario en Firebase
        await setDoc(doc(db, "usuarios", cedula), { coins_actuales: coinsUsuario - totalCarrito }, { merge: true });
        coinsUsuario -= totalCarrito;

        carrito = [];
        actualizarCarrito();
        alertaCoins.innerText = "✅ Productos solicitados correctamente";
        alertaCoins.style.display = "block";

    } catch (err) {
        console.error(err);
        alertaCoins.innerText = "❌ Error al solicitar productos";
        alertaCoins.style.display = "block";
    }
});

// Botón buscar
buscarBtn.addEventListener("click", () => {
    const cedula = cedulaInput.value.trim();
    if (cedula) mostrarUsuario(cedula);
});
</script>
</body>
</html>
